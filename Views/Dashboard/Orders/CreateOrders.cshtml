@model OnlineStoreMVC.Models.ViewModels.OrderFormViewModel
@{
  Layout = "~/Views/Shared/_DashboardLayout.cshtml";
  ViewData["Title"] = "T·∫°o ƒë∆°n h√†ng";
}

<div class="d-flex justify-content-center mt-5">
  <div class="card shadow" style="width: 1000px;">
    <div class="card-header bg-success text-white">
      <h4 class="mb-0">üì¶ T·∫°o ƒë∆°n h√†ng</h4>
    </div>
    <div class="card-body">
      @Html.ValidationSummary(true, "", new { @class = "error-message" })

      <form asp-action="Create" method="post">
        <div class="mb-3">
          <label asp-for="UserID" class="form-label">Ng∆∞·ªùi ƒë·∫∑t h√†ng</label>
          <select asp-for="UserID" class="form-select" asp-items="ViewBag.Users">
            <option value="">-- Vui l√≤ng ch·ªçn ng∆∞·ªùi d√πng --</option>
          </select>
          <span asp-validation-for="UserID" class="text-danger"></span>
        </div>

        <div class="mb-3">
          <label asp-for="Status" class="form-label">Tr·∫°ng th√°i ƒë∆°n h√†ng</label>
          <select asp-for="Status" class="form-select">
            <option value="Pending">Pending</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Shipping">Shipping</option>
            <option value="Completed">Completed</option>
          </select>
          <span asp-validation-for="Status" class="text-danger"></span>
        </div>

        <div class="mb-3">
          <label asp-for="Description" class="form-label">Ghi ch√∫ ƒë∆°n h√†ng</label>
          <textarea asp-for="Description" class="form-control" rows="3"
            placeholder="V√≠ d·ª•: Giao trong gi·ªù h√†nh ch√≠nh, g·ªçi tr∆∞·ªõc khi giao..."></textarea>
          <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
          <h5>üõí S·∫£n ph·∫©m</h5>
          <button type="button" class="btn btn-outline-secondary" onclick="addProductRow()">‚ûï Th√™m s·∫£n ph·∫©m</button>
        </div>
        <div id="product-list">
          @for (int i = 0; i < Model.Items.Count; i++)
          {
            <div class="row mb-2 product-row">
              <div class="col-md-6">
                <label asp-for="Items[@i].VariantID" class="form-label">S·∫£n ph·∫©m</label>
                <select asp-for="Items[@i].VariantID" class="form-select variant-select" asp-items="ViewBag.Variants">
                  <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                </select>
                <span asp-validation-for="Items[@i].VariantID" class="text-danger"></span>
              </div>
              <div class="col-md-4">
                <label asp-for="Items[@i].Quantity" class="form-label">S·ªë l∆∞·ª£ng</label>
                <input type="number" asp-for="Items[@i].Quantity" class="form-control" placeholder="S·ªë l∆∞·ª£ng" min="1" />
                <span asp-validation-for="Items[@i].Quantity" class="text-danger"></span>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-danger mb-1" onclick="removeRow(this)">‚ûñ</button>
              </div>
            </div>
          }
        </div>

        <button type="submit" class="btn btn-success">T·∫°o m·ªõi</button>
        <a href="/Dashboard/Orders" class="btn btn-secondary ms-2">Quay l·∫°i</a>
      </form>
    </div>
  </div>
</div>

@section Scripts {
  <partial name="_ValidationScriptsPartial" />
  <script>
    let productIndex = @Model.Items.Count;
    const variantOptions = document.querySelector(".variant-select").innerHTML;

    function addProductRow() {
      const container = document.getElementById("product-list");
      const idx = productIndex++;

      const row = document.createElement("div");
      row.className = "row mb-2 product-row";
      row.innerHTML = `
                    <div class="col-md-6">
                      <label for="Items_${idx}__VariantID" class="form-label">S·∫£n ph·∫©m</label>
                      <select name="Items[${idx}].VariantID"
                              id="Items_${idx}__VariantID"
                              class="form-select">
                        ${variantOptions}
                      </select>
                      <span class="text-danger"
                            data-valmsg-for="Items[${idx}].VariantID"
                            data-valmsg-replace="true"></span>
                    </div>
                    <div class="col-md-4">
                      <label for="Items_${idx}__Quantity" class="form-label">S·ªë l∆∞·ª£ng</label>
                      <input name="Items[${idx}].Quantity"
                             id="Items_${idx}__Quantity"
                             type="number" min="1"
                             class="form-control" />
                      <span class="text-danger"
                            data-valmsg-for="Items[${idx}].Quantity"
                            data-valmsg-replace="true"></span>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button type="button" class="btn btn-danger mb-1"
                              onclick="removeRow(this)">‚ûñ</button>
                    </div>`;

      container.appendChild(row);
      $.validator.unobtrusive.parse(container);
    }

    function removeRow(btn) {
      const rows = document.querySelectorAll(".product-row");
      if (rows.length > 1) {
        btn.closest(".product-row").remove();
      } else {
        alert("Ph·∫£i c√≥ √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m trong ƒë∆°n.");
      }
    }
  </script>
}