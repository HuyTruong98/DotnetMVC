@model IEnumerable<OnlineStoreMVC.Models.Product>
@using OnlineStoreMVC.Helpers

@{
  Layout = "~/Views/Shared/_DashboardLayout.cshtml";
  ViewData["Title"] = "Qu·∫£n l√Ω s·∫£n ph·∫©m";
}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">üì¶ Danh s√°ch s·∫£n ph·∫©m</h2>
  <a class="btn btn-success" asp-controller="DashboardProduct" asp-action="Create">‚ûï T·∫°o m·ªõi</a>
</div>

<div class="table-responsive">
  <table class="table table-bordered table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:100px;">·∫¢nh</th>
        <th>T√™n s·∫£n ph·∫©m</th>
        <th>Lo·∫°i</th>
        <th style="width:120px;">Gi√°</th>
        <th style="width:120px;">Gi√° gi·∫£m</th>
        <th style="width:100px;">T·ªïng t·ªìn kho</th>
        <th style="width:100px;">Tr·∫°ng th√°i</th>
        <th style="width:80px;">N·ªïi b·∫≠t</th>
        <th style="width:140px;">Ng√†y t·∫°o</th>
        <th style="width:180px;">Thao t√°c</th>
      </tr>
    </thead>
    <tbody>
      @if (!Model.Any())
      {
        <tr>
          <td colspan="11" class="text-center text-muted py-4">
            Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o
          </td>
        </tr>
      }
      else
      {
        var i = 0;
        foreach (var product in Model)
        {
          // L·∫•y khuy·∫øn m√£i, gi√° gi·∫£m
          var promotions = ViewBag.Promotions as List<OnlineStoreMVC.Models.Promotion> ?? new();
          var promo = promotions.FirstOrDefault(p => p.ProductID == product.ProductID);
          var discountedPrice = promo != null
          ? product.Price * (1 - (decimal)promo.DiscountPercent / 100)
          : 0m;

          // ·∫¢nh ch√≠nh
          var primaryImage = product.ProductImages
          .FirstOrDefault(img => img.IsPrimary)
          ?? product.ProductImages.FirstOrDefault();

          // T·ªïng t·ªìn kho
          var totalStock = product.Variants?.Sum(v => v.Stock) ?? 0;

          // Badge tr·∫°ng th√°i
          var badgeClass = product.Status switch
          {
            "Available" => "bg-success",
            "OutOfStock" => "bg-danger",
            "Promotion" => "bg-warning text-dark",
            _ => "bg-secondary"
          };
          <tr>
            <td>@(++i)</td>
            <td>
              @if (primaryImage != null)
              {
                <img src="@primaryImage.ImageURL" width="80" class="img-thumbnail" />
              }
              else
              {
                <span class="text-muted">Kh√¥ng c√≥ ·∫£nh</span>
              }
            </td>
            <td>@product.ProductName</td>
            <td>@product.Category?.CategoryName</td>
            <td>@FormatHelper.FormatCurrency(product.Price)</td>
            <td>
              @if (promo != null)
              {
                <span class="text-success fw-bold">
                  @FormatHelper.FormatCurrency(discountedPrice)
                </span>
              }
              else
              {
                <span class="text-muted">‚Äî</span>
              }
            </td>
            <td>@totalStock</td>
            <td><span class="badge @badgeClass">@product.Status</span></td>
            <td class="text-center">@(product.IsFeatured ? "‚úîÔ∏è" : "‚ùå")</td>
            <td>@FormatHelper.FormatDate(product.CreatedAt)</td>
            <td>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse"
                  data-bs-target="#variants-@product.ProductID" aria-expanded="false"
                  aria-controls="variants-@product.ProductID">
                  Chi ti·∫øt
                </button>
                <a class="btn btn-sm btn-warning" asp-action="Edit" asp-route-id="@product.ProductID">
                  S·ª≠a
                </a>
                <form asp-action="Delete" asp-route-id="@product.ProductID" method="post"
                  onsubmit="return confirm('X√°c nh·∫≠n x√≥a?');" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-danger">
                    X√≥a
                  </button>
                </form>
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="11" class="p-0 bg-light">
              <div class="collapse" id="variants-@product.ProductID">
                <div class="p-2">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <strong>Size ‚Äì M√†u ‚Äì T·ªìn kho:</strong>
                  </div>
                  <table class="table table-sm table-striped mt-2 mb-0">
                    <thead>
                      <tr>
                        <th style="width:150px;">Size</th>
                        <th style="width:150px;">M√†u s·∫Øc</th>
                        <th style="width:150px;">T·ªìn kho</th>
                      </tr>
                    </thead>
                    <tbody>
                      @if (product.Variants != null && product.Variants.Any())
                      {
                        foreach (var v in product.Variants)
                        {
                          <tr>
                            <td>@v.Size</td>
                            <td>@v.Color</td>
                            <td>@v.Stock</td>
                          </tr>
                        }
                      }
                      else
                      {
                        <tr>
                          <td colspan="3" class="text-center text-muted">
                            Kh√¥ng c√≥ bi·∫øn th·ªÉ
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>