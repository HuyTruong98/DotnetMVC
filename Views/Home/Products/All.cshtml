@using OnlineStoreMVC.Helpers
@model List<OnlineStoreMVC.Models.Product>
@{
  Layout = "~/Views/Shared/_Layout.cshtml";

  int totalCount = ViewBag.TotalCount;
  int page = ViewBag.Page;
  int pageSize = ViewBag.PageSize;
  int totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
}

<div class="container" style="margin-top: 80px">
  <h2 class="mb-4">üõçÔ∏è T·∫•t c·∫£ s·∫£n ph·∫©m</h2>

  <form method="get" asp-action="All" asp-controller="HomeProduct">
    <div class="row mb-3">
      <div class="col-md-6">
        <input type="text" name="search" value="@ViewBag.Search" class="form-control" placeholder="üîç T√¨m ki·∫øm..." />
      </div>
      <div class="col-md-6 text-end">
        <select name="sort" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
          <option value="default" selected="@(ViewBag.Sort == "default")">-- S·∫Øp x·∫øp --</option>
          <option value="asc" selected="@(ViewBag.Sort == "asc")">Gi√° ‚Üë (th·∫•p ‚Üí cao)</option>
          <option value="desc" selected="@(ViewBag.Sort == "desc")">Gi√° ‚Üì (cao ‚Üí th·∫•p)</option>
        </select>
      </div>
    </div>
  </form>

  <div class="row g-4">
    @foreach (var product in Model)
    {
      var imgUrl = product.ProductImages?.FirstOrDefault()?.ImageURL ?? "/images/no-image.png";
      var promotions = ViewBag.Promotions as List<OnlineStoreMVC.Models.Promotion> ?? new();
      var promo = promotions.FirstOrDefault(p => p.ProductID == product.ProductID);
      var discountedPrice = promo != null
      ? product.Price * (1 - (decimal)promo.DiscountPercent / 100)
      : 0m;

      <div class="col-lg-3 col-md-6">
        <div class="product-card">
          <div class="product-image">
            <a asp-controller="HomeProduct" asp-action="Detail" asp-route-id="@product.ProductID">
              <img src="@Url.Content(imgUrl)" class="img-fluid w-100" alt="@product.ProductName"
                style="object-fit: contain;" />
            </a>
            <div class="product-badges">
              @if (promo != null)
              {
                <span class="badge bg-danger">-@promo.DiscountPercent%</span>
              }
            </div>
          </div>
          <div class="product-info">
            <h6 class="product-title">
              <a asp-controller="HomeProduct" asp-action="Detail" asp-route-id="@product.ProductID"
                class="text-decoration-none text-dark">@product.ProductName</a>
            </h6>
            <div class="product-price">
              @if (promo != null)
              {
                <del class="price-sale">@FormatHelper.FormatCurrency(product.Price)</del>
                <span class="current-price">@FormatHelper.FormatCurrency(discountedPrice)</span>
              }
              else
              {
                <span class="current-price">@FormatHelper.FormatCurrency(product.Price)</span>
              }
            </div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Pagination -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      @for (int i = 1; i <= totalPages; i++)
      {
        <li class="page-item @(i == page ? "active" : "")">
          <a class="page-link" asp-action="All" asp-controller="HomeProduct" asp-route-search="@ViewBag.Search"
            asp-route-sort="@ViewBag.Sort" asp-route-page="@i">@i</a>
        </li>
      }
    </ul>
  </nav>
</div>