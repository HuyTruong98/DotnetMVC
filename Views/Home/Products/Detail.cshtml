@using System.Text.Json
@using OnlineStoreMVC.Helpers
@model OnlineStoreMVC.Models.Product

@{
  Layout = "~/Views/Shared/_Layout.cshtml";
  ViewData["Title"] = "Chi ti·∫øt s·∫£n ph·∫©m";

  var promo = ViewBag.ActivePromotion as OnlineStoreMVC.Models.Promotion;

  decimal discountedPrice = promo != null
  ? Math.Round(Model.Price * (1 - promo.DiscountPercent / 100m), 0)
  : 0m;

  var jsonVariants = JsonSerializer.Serialize(
  Model.Variants
  .Select(v => new
  {
    color = v.Color,
    size = v.Size,
    stock = v.Stock
  })
  );
  bool firstSelectable = true;

  var recentlyViewed = ViewBag.RecentlyViewed as List<Product> ?? new();
  var promotionProducts = ViewBag.PromotionProducts as List<OnlineStoreMVC.Models.Promotion> ?? new();

}

<div class="container mt-4" style="padding-top: 30px">
  <div class="row">
    <!-- H√¨nh ·∫£nh s·∫£n ph·∫©m -->
    <div class="col-md-6">
      <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
        <!-- ·∫¢nh to -->
        <div class="carousel-inner">
          @if (Model.ProductImages != null && Model.ProductImages.Any())
          {
            var first = true;
            foreach (var img in Model.ProductImages)
            {
              <div class="carousel-item @(first ? "active" : "")">
                <img src="@img.ImageURL" class="d-block w-100" style="max-width:100%; height:612px; object-fit:contain;"
                  alt="@Model.ProductName" />
              </div>
              first = false;
            }
          }
          else
          {
            <div class="carousel-item active">
              <img src="/images/no-image.png" class="d-block w-100"
                style="max-width:100%; height:612px; object-fit:contain;" alt="No image" />
            </div>
          }
        </div>

        <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng ·∫£nh l·ªõn -->
        <button type="button" class="custom-control-btn custom-prev" data-bs-target="#productCarousel"
          data-bs-slide="prev">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button type="button" class="custom-control-btn custom-next" data-bs-target="#productCarousel"
          data-bs-slide="next">
          <i class="fas fa-chevron-right"></i>
        </button>

        <!-- Thumbnail nh·ªè d∆∞·ªõi -->
        <div class="mt-2">
          <div id="thumbWrapper" class="d-flex overflow-auto"
            style="gap:8px; scroll-behavior:smooth; white-space:nowrap;">
            @if (Model.ProductImages != null && Model.ProductImages.Any())
            {
              var idx = 0;
              foreach (var img in Model.ProductImages)
              {
                <img src="@img.ImageURL" class="img-thumbnail thumb @(idx == 0 ? "active" : "")"
                  style="width:70px; height:70px; object-fit:cover; cursor:pointer; border:1px solid #e5e5e5;"
                  data-bs-target="#productCarousel" data-bs-slide-to="@idx" aria-current="@(idx == 0 ? "true" : "false")" />
                idx++;
              }
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Th√¥ng tin chi ti·∫øt -->
    <div class="col-md-6">
      <h3>@Model.ProductName</h3>
      <p>M√£ s·∫£n ph·∫©m: <strong>@Model.ProductID</strong></p>

      @if (promo != null)
      {
        <div class="d-flex">
          <span class="current-price pr-2">
            <del class="price-sale">
              @FormatHelper.FormatCurrency(@Model.Price)
            </del>
          </span>&emsp;
          <h4 style="color: #001F5D">@FormatHelper.FormatCurrency(discountedPrice)</h4>
        </div>
      }
      else
      {
        <h4 style="color: #001F5D">@FormatHelper.FormatCurrency(@Model.Price)</h4>
      }


      <div
        style=" padding: 10px; margin-bottom: 10px; border: 2px dashed #b00002; margin-top: 20px; position: relative;">
        <h6
          style=" margin-bottom: 8px; font-size: 0.875rem; font-weight: 600; padding: 5px 10px; color: #b00002; background: #fff; position: absolute; top: -14px;">
          üéÅ KHUY·∫æN M√ÉI - ∆ØU ƒê√ÉI</h6>

        <ul>
          <li>Nh·∫≠p m√£ <b>SEP9</b> gi·∫£m 9k ƒë∆°n t·ª´ 0ƒë</li>
          <li>Nh·∫≠p m√£ <b>SEP30</b> gi·∫£m 30k ƒë∆°n t·ª´ 299k</li>
          <li>Nh·∫≠p m√£ <b>SEP50</b> gi·∫£m 50k ƒë∆°n t·ª´ 599k</li>
          <li>Nh·∫≠p m√£ <b>SEP100</b> gi·∫£m 100k ƒë∆°n t·ª´ 999k</li>
          <li>Freeship ƒë∆°n h√†ng t·ª´ 399k</li>
        </ul>
      </div>


      <form method="get">
        <input type="hidden" name="ProductID" value="@Model.ProductID" />
        <!-- M√†u s·∫Øc -->
        <div class="mb-3">
          <label class="form-label me-2">M√†u s·∫Øc:</label>
          <div id="colorOptions" class="d-flex flex-wrap">
            @foreach (var color in (List<string>)ViewBag.Colors)
            {
              <div class="form-check me-3">
                <input class="form-check-input color-radio" type="radio" name="SelectedColor"
                  id="color_@color.Replace(" ", "_")" value="@color" @(color == (string)ViewBag.SelectedColor ? "checked":
                                                                                     "") required onchange="this.form.submit()" />
                <label class="form-check-label" for="color_@color.Replace(" ", "_")" style="cursor:pointer;">
                  @color
                </label>
              </div>
            }
          </div>
        </div>
      </form>

      <form asp-controller="HomeCart" asp-action="AddToCart" method="post">
        <input type="hidden" name="ProductID" value="@Model.ProductID" />
        <!-- Size -->
        <div class="mb-3">
          <label class="form-label me-2">Size:</label>
          <div id="sizeOptions" class="d-flex flex-wrap swatch">
            @{
              bool firstSelectable = true;
              var selectedColor = (string)ViewBag.SelectedColor;
              var filteredVariants = ((List<ProductVariant>)ViewBag.Sizes)
              .Where(v => v.Color == selectedColor)
              .ToList();

              foreach (var variant in filteredVariants)
              {
                var disabled = variant.Stock == 0 ? "disabled" : "";
                var isChecked = (!variant.Stock.Equals(0) && firstSelectable) ? "checked" : "";
                if (!string.IsNullOrEmpty(isChecked)) firstSelectable = false;
                <div class="swatch-element">
                  <input type="radio" name="VariantID" id="size_@variant.VariantID" value="@variant.VariantID" @disabled
                    @isChecked required />
                  <label for="size_@variant.VariantID">@variant.Size</label>
                </div>
              }
            }
          </div>
        </div>


        <!-- Quantity & button -->
        <div class="mt-3 d-flex align-items-center" id="product-template">
          <div class="quantity-area">
            <input type="button" value="‚Äì" id="qtyMinus" class="qty-btn qtyminus">
            <input type="number" id="quantity" name="Quantity" value="1" min="1" class="quantity-selector" readonly>
            <input type="button" value="+" id="qtyPlus" class="qty-btn qtyplus">
          </div>

          <button type="submit" class="btn ms-3 px-4 add-to-cart-btn"
            style="border: 1px solid #001F5D; color:#001F5D; background-color:#fff; width:100%">
            TH√äM V√ÄO GI·ªé
          </button>
        </div>
      </form>

      <!-- N√∫t mua ngay -->
      <div class="mt-3">
        <button class="btn w-100" style="background-color: #001f60; color: #fff;">MUA NGAY</button>
      </div>
      <ul
        class="product-policises list-unstyled d-flex justify-content-between py-sm-3 px-sm-3 m-0 mt-3 border rounded">
        <li class="d-flex align-items-center me-3">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_1.png?v=5373"
            alt="Freeship ƒë∆°n t·ª´ 399K">
          <span style="font-size:14px">Freeship ƒë∆°n t·ª´ 399K</span>
        </li>
        <li class="d-flex align-items-center me-3">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_2.png?v=5373"
            alt="C·ªông d·ªìn Membership ƒë·∫øn 15%">
          <span style="font-size:14px">C·ªông d·ªìn Membership ƒë·∫øn 15%</span>
        </li>
        <li class="d-flex align-items-center me-3">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_3.png?v=5373" alt="Thanh to√°n COD">
          <span style="font-size:14px">Thanh to√°n COD</span>
        </li>
        <li class="d-flex align-items-center">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_4.png?v=5373"
            alt="ƒê·ªïi tr·∫£ trong 15 ng√†y">
          <span style="font-size:14px">ƒê·ªïi tr·∫£ trong 15 ng√†y</span>
        </li>
      </ul>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mt-4" id="productTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button"
          role="tab">
          V·ªÄ CH√öNG T√îI
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button"
          role="tab">
          CH√çNH S√ÅCH GIAO H√ÄNG
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="return-tab" data-bs-toggle="tab" data-bs-target="#return" type="button" role="tab">
          CH√çNH S√ÅCH ƒê·ªîI H√ÄNG
        </button>
      </li>
    </ul>

    <!-- N·ªôi dung c·ªßa Tabs -->
    <div class="tab-content border-start border-end border-bottom p-3" id="productTabContent">
      <!-- Tab V·ªÅ ch√∫ng t√¥i -->
      <div class="tab-pane fade show active" id="desc" role="tabpanel">
        <h5>V·ªÅ onlineStoreMVC</h5>
        <p>
          Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi <strong>onlineStoreMVC¬Æ</strong> ‚Äì th∆∞∆°ng hi·ªáu th·ªùi trang nam ch√≠nh h√£ng,
          mang ƒë·∫øn cho b·∫°n nh·ªØng s·∫£n ph·∫©m <b>ch·∫•t l∆∞·ª£ng cao</b>, <b>thi·∫øt k·∫ø hi·ªán ƒë·∫°i</b>
          v√† lu√¥n b·∫Øt k·ªãp xu h∆∞·ªõng m·ªõi nh·∫•t.
        </p>
        <ul>
          <li>‚úîÔ∏è <strong>S·∫£n ph·∫©m ch√≠nh h√£ng</strong> ‚Äì Cam k·∫øt 100% h√†ng chu·∫©n, kh√¥ng pha tr·ªôn, kh√¥ng h√†ng
            gi·∫£.</li>
          <li>‚úîÔ∏è <strong>Ch·∫•t l∆∞·ª£ng v∆∞·ª£t tr·ªôi</strong> ‚Äì ƒê∆∞·ª£c s·∫£n xu·∫•t t·ª´ nh·ªØng ch·∫•t li·ªáu b·ªÅn ƒë·∫πp, tho·∫£i m√°i.
          </li>
          <li>‚úîÔ∏è <strong>ƒê·ªïi tr·∫£ d·ªÖ d√†ng</strong> ‚Äì H·ªó tr·ª£ ƒë·ªïi tr·∫£ trong v√≤ng <b>15 ng√†y</b> n·∫øu s·∫£n ph·∫©m l·ªói
            ho·∫∑c kh√¥ng v·ª´a size.</li>
          <li>‚úîÔ∏è <strong>Giao h√†ng to√†n qu·ªëc</strong> ‚Äì Nhanh ch√≥ng, ti·ªán l·ª£i, freeship cho ƒë∆°n t·ª´ 399K.</li>
          <li>‚úîÔ∏è <strong>Ph·ª•c v·ª• t·∫≠n t√¢m</strong> ‚Äì ƒê·ªôi ng≈© CSKH s·∫µn s√†ng h·ªó tr·ª£ 24/7.</li>
        </ul>
        <p>
          Ch√∫ng t√¥i tin r·∫±ng <b>th·ªùi trang kh√¥ng ch·ªâ l√† qu·∫ßn √°o</b>,
          m√† c√≤n l√† <b>c√°ch b·∫°n th·ªÉ hi·ªán c√° t√≠nh v√† phong c√°ch s·ªëng</b>.
          H√£y ƒë·ªÉ onlineStoreMVC¬Æ ƒë·ªìng h√†nh c√πng b·∫°n tr√™n m·ªçi h√†nh tr√¨nh.
        </p>
      </div>

      <!-- Tab Ch√≠nh s√°ch giao h√†ng -->
      <div class="tab-pane fade" id="shipping" role="tabpanel">
        <div class="d-flex justify-content-center">
          <img src="~/images/chinhsachgiaohang.jpg" alt="Ch√≠nh s√°ch giao h√†ng" />
        </div>
      </div>

      <!-- Tab Ch√≠nh s√°ch ƒë·ªïi h√†ng -->
      <div class="tab-pane fade" id="return" role="tabpanel">
        <img style="width: 100%" src="~/images/chinhsach2.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 1" />
        <img style="width: 100%" src="~/images/chinhsach3.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 2" />
        <img style="width: 100%" src="~/images/chinhsach4.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 3" />
        <img style="width: 100%" src="~/images/chinhsach5.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 4" />
      </div>
    </div>


    @if (recentlyViewed != null && recentlyViewed.Any())
    {
      <section class="featured-products py-3 bg-light">
        <div class="container">
          <div class="section-header text-center mb-5">
            <h2 class="section-title">S·∫£n ph·∫©m b·∫°n ƒë√£ xem</h2>
            <p class="section-subtitle">Nh·ªØng s·∫£n ph·∫©m b·∫°n ƒë√£ xem g·∫ßn ƒë√¢y</p>
          </div>

          <div id="multiCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">

              @{
                var chunkedProducts = recentlyViewed.Chunk(4).ToList();
              }
              @for (int i = 0; i < chunkedProducts.Count; i++)
              {
                <div class="carousel-item @(i == 0 ? "active" : "")">
                  <div class="row g-4">
                    @foreach (var product in chunkedProducts[i])
                    {
                      var primaryImage = product.ProductImages?.FirstOrDefault(img => img.IsPrimary);
                      var promoList = product.Promotions?.FirstOrDefault(p => p.EndDate > DateTime.Now);
                      var discountedPriceList = promo != null
                      ? product.Price * (1 - (decimal)promo.DiscountPercent / 100)
                      : product.Price;

                      <div class="col-lg-3 col-md-6 col-12">
                        <div class="product-card">
                          <div class="product-image">
                            <a asp-controller="HomeProduct" asp-action="Detail" asp-route-id="@product.ProductID">
                              <img src="@(primaryImage?.ImageURL ?? "/images/no-image.png")" class="img-hot"
                                alt="@product.ProductName" />
                            </a>
                            @if (promoList != null)
                            {
                              <div class="product-badges">
                                <span class="badge bg-danger">-@promoList.DiscountPercent%</span>
                              </div>
                            }
                          </div>
                          <div class="product-info">
                            <h6 class="product-title">
                              <a asp-controller="HomeProduct" asp-action="Detail" asp-route-id="@product.ProductID"
                                class="text-decoration-none text-dark">
                                @product.ProductName
                              </a>
                            </h6>
                            <div class="product-price">
                              @if (promoList != null)
                              {
                                <span class="current-price">
                                  <del class="price-sale">@FormatHelper.FormatCurrency(product.Price)</del>
                                </span>
                                <span class="current-price">
                                  @FormatHelper.FormatCurrency(discountedPriceList)
                                </span>
                              }
                              else
                              {
                                <span class="current-price">
                                  @FormatHelper.FormatCurrency(product.Price)
                                </span>
                              }
                            </div>
                            <div class="mt-2">
                              <a asp-controller="HomeProduct" asp-action="Detail" asp-route-id="@product.ProductID"
                                class="btn btn-sm btn-primary w-100 add-to-cart-btn text-decoration-none d-flex align-items-center justify-content-center gap-2">
                                <i class="fas fa-eye"></i>
                                <span>Xem Chi Ti·∫øt</span>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>

            <!-- Controls -->
            <button class="carousel-control-prev custom-control-btn custom-next" type="button"
              data-bs-target="#multiCarousel" data-bs-slide="prev">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="carousel-control-next custom-control-btn custom-next" type="button"
              data-bs-target="#multiCarousel" data-bs-slide="next">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </section>
    }

  </div>
</div>

@section Scripts {
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const thumbs = document.querySelectorAll("#thumbWrapper .thumb");
      const carousel = document.getElementById("productCarousel");
      const thumbWrapper = document.getElementById("thumbWrapper");

      thumbs.forEach((t) => {
        t.addEventListener("click", () => {
          thumbs.forEach((x) => {
            x.classList.remove("active");
            x.style.border = "1px solid #e5e5e5";
          });

          t.classList.add("active");
          t.style.border = "1px solid #000";
        });
      });

      carousel.addEventListener("slid.bs.carousel", (e) => {
        const index = e.to;
        thumbs.forEach((thumb, i) => {
          const isActive = i === index;

          thumb.classList.toggle("active", isActive);
          thumb.style.border = isActive ? "1px solid #000" : "1px solid #e5e5e5";
        });

        const activeThumb = thumbs[index];
        if (activeThumb) {
          activeThumb.scrollIntoView({
            behavior: "smooth",
            inline: "center",
            block: "nearest",
          });
        }
      });

      if (thumbs.length > 0) {
        thumbs[0].classList.add("active");
        thumbs[0].style.border = "1px solid #000";
      }
    });

    document.getElementById("qtyMinus").addEventListener("click", function () {
      let qtyInput = document.getElementById("quantity");
      let val = parseInt(qtyInput.value) || 1;
      if (val > 1) qtyInput.value = val - 1;
    });

    document.getElementById("qtyPlus").addEventListener("click", function () {
      let qtyInput = document.getElementById("quantity");
      let val = parseInt(qtyInput.value) || 1;
      qtyInput.value = val + 1;
    });

  </script>
}