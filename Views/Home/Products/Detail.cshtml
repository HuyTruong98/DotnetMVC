@using System.Text.Json
@using OnlineStoreMVC.Helpers
@model OnlineStoreMVC.Models.Product

@{
  Layout = "~/Views/Shared/_Layout.cshtml";
  ViewData["Title"] = "Chi ti·∫øt s·∫£n ph·∫©m";

  var promo = ViewBag.ActivePromotion as OnlineStoreMVC.Models.Promotion;

  decimal discountedPrice = promo != null
  ? Math.Round(Model.Price * (1 - promo.DiscountPercent / 100m), 0)
  : 0m;

  var jsonVariants = JsonSerializer.Serialize(
  Model.Variants
  .Select(v => new
  {
    color = v.Color,
    size = v.Size,
    stock = v.Stock
  })
  );
}

<div class="container mt-4" style="padding-top: 30px">
  <div class="row">
    <!-- H√¨nh ·∫£nh s·∫£n ph·∫©m -->
    <div class="col-md-6 d-flex">
      <div class="d-flex flex-column me-3">
        @if (Model.ProductImages != null && Model.ProductImages.Any())
        {
          foreach (var img in Model.ProductImages)
          {
            <img src="@img.ImageURL" class="img-thumbnail mb-2 thumb" style="width:80px; cursor:pointer;"
              onclick="changeImage('@img.ImageURL')" />
          }
        }
      </div>
      <div class="flex-grow-1">
        <img id="mainImage" src="@(Model.ProductImages?.FirstOrDefault()?.ImageURL ?? "/images/no-image.png")"
          class="img-fluid mb-3 border" style="max-width: 100%; height: auto; width: 100%" alt="@Model.ProductName" />
      </div>
    </div>


    <!-- Th√¥ng tin chi ti·∫øt -->
    <div class="col-md-6">
      <h3>@Model.ProductName</h3>
      <p>M√£ s·∫£n ph·∫©m: <strong>@Model.ProductID</strong></p>

      @if (promo != null)
      {
        <div class="d-flex">
          <span class="current-price pr-2">
            <del class="price-sale">
              @FormatHelper.FormatCurrency(@Model.Price)
            </del>
          </span>&emsp;
          <h4 style="color: #001F5D">@FormatHelper.FormatCurrency(discountedPrice)</h4>
        </div>
      }
      else
      {
        <h4 style="color: #001F5D">@FormatHelper.FormatCurrency(@Model.Price)</h4>
      }


      <div
        style=" padding: 10px; margin-bottom: 10px; border: 2px dashed #b00002; margin-top: 20px; position: relative;">
        <h6
          style=" margin-bottom: 8px; font-size: 0.875rem; font-weight: 600; padding: 5px 10px; color: #b00002; background: #fff; position: absolute; top: -14px;">
          üéÅ KHUY·∫æN M√ÉI - ∆ØU ƒê√ÉI</h6>

        <ul>
          <li>Nh·∫≠p m√£ <b>SEP9</b> gi·∫£m 9k ƒë∆°n t·ª´ 0ƒë</li>
          <li>Nh·∫≠p m√£ <b>SEP30</b> gi·∫£m 30k ƒë∆°n t·ª´ 299k</li>
          <li>Nh·∫≠p m√£ <b>SEP50</b> gi·∫£m 50k ƒë∆°n t·ª´ 599k</li>
          <li>Nh·∫≠p m√£ <b>SEP100</b> gi·∫£m 100k ƒë∆°n t·ª´ 999k</li>
          <li>Freeship ƒë∆°n h√†ng t·ª´ 399k</li>
        </ul>
      </div>

      <div class="mb-3">
        <label class="form-label me-2">M√†u s·∫Øc:</label>
        <div id="colorOptions" class="d-flex flex-wrap">
          @foreach (var color in (List<string>)ViewBag.Colors)
          {
            <div class="form-check me-3">
              <input class="form-check-input color-radio" type="radio" name="color" id="color_@color.Replace(" ", "_")"
                value="@color" />
              <label class="form-check-label" for="color_@color.Replace(" ", "_")" style="cursor:pointer;">
                @color
              </label>
            </div>
          }
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label me-2">Size:</label>
        <div id="sizeOptions" class="d-flex flex-wrap">
          <!-- JS s·∫Ω render c√°c n√∫t ·ªü ƒë√¢y -->
        </div>
      </div>

      <div class="mt-3 d-flex align-items-center">
        <!-- √î s·ªë l∆∞·ª£ng -->
        <div class="d-flex align-items-center border rounded px-2" style="width: 120px; height: 40px;">
          <button id="decrease" class="btn p-0 border-0" style="width: 30px;">‚àí</button>
          <span id="quantity" class="flex-grow-1 text-center">1</span>
          <button id="increase" class="btn p-0 border-0" style="width: 30px;">+</button>
        </div>
        <!-- N√∫t th√™m v√†o gi·ªè -->
        <button class="btn btn-outline-primary ms-3 px-4 add-to-cart-btn" data-product-id="@Model.ProductID">TH√äM V√ÄO
          GI·ªé</button>
      </div>

      <!-- N√∫t mua ngay -->
      <div class="mt-3">
        <button class="btn w-100" style="background-color: #001f60; color: #fff;">MUA NGAY</button>
      </div>
      <ul
        class="product-policises list-unstyled d-flex justify-content-between py-sm-3 px-sm-3 m-0 mt-3 border rounded">
        <li class="d-flex align-items-center me-3">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_1.png?v=5373"
            alt="Freeship ƒë∆°n t·ª´ 399K">
          <span style="font-size:14px">Freeship ƒë∆°n t·ª´ 399K</span>
        </li>
        <li class="d-flex align-items-center me-3">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_2.png?v=5373"
            alt="C·ªông d·ªìn Membership ƒë·∫øn 15%">
          <span style="font-size:14px">C·ªông d·ªìn Membership ƒë·∫øn 15%</span>
        </li>
        <li class="d-flex align-items-center me-3">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_3.png?v=5373" alt="Thanh to√°n COD">
          <span style="font-size:14px">Thanh to√°n COD</span>
        </li>
        <li class="d-flex align-items-center">
          <img class="img-fluid me-2" width="27" height="27"
            src="//theme.hstatic.net/1000360022/1001381352/14/policy_product_image_4.png?v=5373"
            alt="ƒê·ªïi tr·∫£ trong 15 ng√†y">
          <span style="font-size:14px">ƒê·ªïi tr·∫£ trong 15 ng√†y</span>
        </li>
      </ul>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mt-4" id="productTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button"
          role="tab">
          V·ªÄ CH√öNG T√îI
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button"
          role="tab">
          CH√çNH S√ÅCH GIAO H√ÄNG
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="return-tab" data-bs-toggle="tab" data-bs-target="#return" type="button" role="tab">
          CH√çNH S√ÅCH ƒê·ªîI H√ÄNG
        </button>
      </li>
    </ul>

    <!-- N·ªôi dung c·ªßa Tabs -->
    <div class="tab-content border-start border-end border-bottom p-3" id="productTabContent">
      <!-- Tab V·ªÅ ch√∫ng t√¥i -->
      <div class="tab-pane fade show active" id="desc" role="tabpanel">
        <h5>V·ªÅ onlineStoreMVC</h5>
        <p>
          Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi <strong>onlineStoreMVC¬Æ</strong> ‚Äì th∆∞∆°ng hi·ªáu th·ªùi trang nam ch√≠nh h√£ng,
          mang ƒë·∫øn cho b·∫°n nh·ªØng s·∫£n ph·∫©m <b>ch·∫•t l∆∞·ª£ng cao</b>, <b>thi·∫øt k·∫ø hi·ªán ƒë·∫°i</b>
          v√† lu√¥n b·∫Øt k·ªãp xu h∆∞·ªõng m·ªõi nh·∫•t.
        </p>
        <ul>
          <li>‚úîÔ∏è <strong>S·∫£n ph·∫©m ch√≠nh h√£ng</strong> ‚Äì Cam k·∫øt 100% h√†ng chu·∫©n, kh√¥ng pha tr·ªôn, kh√¥ng h√†ng
            gi·∫£.</li>
          <li>‚úîÔ∏è <strong>Ch·∫•t l∆∞·ª£ng v∆∞·ª£t tr·ªôi</strong> ‚Äì ƒê∆∞·ª£c s·∫£n xu·∫•t t·ª´ nh·ªØng ch·∫•t li·ªáu b·ªÅn ƒë·∫πp, tho·∫£i m√°i.
          </li>
          <li>‚úîÔ∏è <strong>ƒê·ªïi tr·∫£ d·ªÖ d√†ng</strong> ‚Äì H·ªó tr·ª£ ƒë·ªïi tr·∫£ trong v√≤ng <b>15 ng√†y</b> n·∫øu s·∫£n ph·∫©m l·ªói
            ho·∫∑c kh√¥ng v·ª´a size.</li>
          <li>‚úîÔ∏è <strong>Giao h√†ng to√†n qu·ªëc</strong> ‚Äì Nhanh ch√≥ng, ti·ªán l·ª£i, freeship cho ƒë∆°n t·ª´ 399K.</li>
          <li>‚úîÔ∏è <strong>Ph·ª•c v·ª• t·∫≠n t√¢m</strong> ‚Äì ƒê·ªôi ng≈© CSKH s·∫µn s√†ng h·ªó tr·ª£ 24/7.</li>
        </ul>
        <p>
          Ch√∫ng t√¥i tin r·∫±ng <b>th·ªùi trang kh√¥ng ch·ªâ l√† qu·∫ßn √°o</b>,
          m√† c√≤n l√† <b>c√°ch b·∫°n th·ªÉ hi·ªán c√° t√≠nh v√† phong c√°ch s·ªëng</b>.
          H√£y ƒë·ªÉ onlineStoreMVC¬Æ ƒë·ªìng h√†nh c√πng b·∫°n tr√™n m·ªçi h√†nh tr√¨nh.
        </p>
      </div>

      <!-- Tab Ch√≠nh s√°ch giao h√†ng -->
      <div class="tab-pane fade" id="shipping" role="tabpanel">
        <div class="d-flex justify-content-center">
          <img src="~/images/chinhsachgiaohang.jpg" alt="Ch√≠nh s√°ch giao h√†ng" />
        </div>
      </div>

      <!-- Tab Ch√≠nh s√°ch ƒë·ªïi h√†ng -->
      <div class="tab-pane fade" id="return" role="tabpanel">
        <img style="width: 100%" src="~/images/chinhsach2.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 1" />
        <img style="width: 100%" src="~/images/chinhsach3.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 2" />
        <img style="width: 100%" src="~/images/chinhsach4.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 3" />
        <img style="width: 100%" src="~/images/chinhsach5.jpg" alt="Ch√≠nh s√°ch ƒë·ªïi h√†ng 4" />
      </div>
    </div>
    <!-- Toast Container -->
    <div class="position-fixed top-0 start-50 translate-middle-x p-6"
      style="z-index: 1100; width: 100%; max-width: 600px;">
      <div id="toastMessage" class="toast w-100 text-bg-success border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body fs-5" id="toastBody">
            "S·∫£n ph·∫©m ƒë√£ th√™m v√†o gi·ªè h√†ng"
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
        </div>
      </div>
    </div>


  </div>
</div>

<script>
  function changeImage(src) {
    document.getElementById("mainImage").src = src;
  }

  const quantityEl = document.getElementById("quantity");
  const decreaseBtn = document.getElementById("decrease");
  const increaseBtn = document.getElementById("increase");

  let quantity = 1;

  decreaseBtn.addEventListener("click", () => {
    if (quantity > 1) {
      quantity--;
      quantityEl.textContent = quantity;
    }
  });

  increaseBtn.addEventListener("click", () => {
    quantity++;
    quantityEl.textContent = quantity;
  });
</script>

<script>
  var variants = @Html.Raw(jsonVariants);

  function renderSizes(color) {
    var container = document.getElementById('sizeOptions');
    container.innerHTML = '';
    variants
      .filter(v => v.color === color)
      .forEach(v => {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-dark btn-sm me-2 mb-2';
        btn.textContent = v.size;
        btn.disabled = v.stock === 0;
        if (v.stock === 0) {
          btn.classList.add('disabled');
        }
        btn.dataset.size = v.size;
        btn.dataset.stock = v.stock;
        container.appendChild(btn);
      });
  }

  // G·∫Øn s·ª± ki·ªán change l√™n m·ªói radio m√†u
  document.querySelectorAll('.color-radio').forEach(radio => {
    radio.addEventListener('change', function () {
      renderSizes(this.value);
    });
  });

  // Auto-ch·ªçn m√†u ƒë·∫ßu ti√™n v√† v·∫Ω size l·∫ßn ƒë·∫ßu
  var first = document.querySelector('.color-radio');
  if (first) {
    first.checked = true;
    renderSizes(first.value);
  }
</script>
@section Scripts {
  <script>
    function showToast(message, isSuccess = true) {
      const toastEl = document.getElementById("toastMessage");
      const toastBody = document.getElementById("toastBody");

      // ƒë·ªïi m√†u theo success/fail
      if (isSuccess) {
        toastEl.classList.remove("text-bg-danger");
        toastEl.classList.add("text-bg-success");
      } else {
        toastEl.classList.remove("text-bg-success");
        toastEl.classList.add("text-bg-danger");
      }

      toastBody.textContent = message;

      const bsToast = new bootstrap.Toast(toastEl);
      bsToast.show();
    }

    $(document).on("click", ".add-to-cart-btn", function () {
      const productId = $(this).data("product-id");
      const quantity = parseInt($("#quantity").text());

      $.ajax({
        url: "/HomeCart/AddToCart",
        type: "POST",
        data: {
          productId: productId,
          quantity: quantity,
          __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
        },
        success: function (res) {
          if (res.success) {
            $("#cart-badge").text(res.cartCount);
            showToast("üõí ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè!", true);
          } else {
            showToast("‚ùå Th√™m gi·ªè th·∫•t b·∫°i!", false);
          }
        },
        error: function () {
          showToast("‚ö†Ô∏è L·ªói server, vui l√≤ng th·ª≠ l·∫°i!", false);
        }
      });
    });
  </script>
}